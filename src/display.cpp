#include "display.h"

#include <GxEPD2_BW.h>
#include <Fonts/FreeMonoBold9pt7b.h>

#include "hw_config.h"
#include "thermocouple.h"

#define MAX_DISPLAY_BUFFER_SIZE 800
#define MAX_HEIGHT(EPD) (EPD::HEIGHT <= MAX_DISPLAY_BUFFER_SIZE / (EPD::WIDTH / 8) ? EPD::HEIGHT : MAX_DISPLAY_BUFFER_SIZE / (EPD::WIDTH / 8))
GxEPD2_BW<GxEPD2_420, MAX_HEIGHT(GxEPD2_420)> display(GxEPD2_420(EPD_CS, EPD_DC, EPD_RST, EPD_BUSY));

static const PROGMEM unsigned char
MagickImage[] = {
    0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0xFE, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x80, 0x07, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x1C,
    0x00, 0x01, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x7E, 0x00,
    0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x3F, 0x80, 0x00, 0x00, 0x02, 0x00,
    0x00, 0x00, 0x1F, 0xC0, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0F, 0xE0,
    0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x07, 0xF8, 0x00, 0x00, 0x30, 0x00,
    0x00, 0x00, 0x07, 0xFC, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x03, 0xFE,
    0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x03, 0xFE, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x01, 0xFF, 0x00, 0x01, 0x00, 0x00, 0x03, 0xC0, 0x01, 0xFF,
    0x80, 0x02, 0x00, 0x00, 0x07, 0xE0, 0x01, 0xFF, 0xC0, 0x00, 0x00, 0x00,
    0x0F, 0xF0, 0x01, 0xFF, 0xC0, 0x04, 0x00, 0x00, 0x0F, 0xF0, 0x01, 0xFF,
    0xE0, 0x08, 0x00, 0x00, 0x0F, 0xF0, 0x01, 0xFF, 0xF0, 0x08, 0x00, 0x00,
    0x0F, 0xF0, 0x01, 0xFF, 0xF0, 0x10, 0x00, 0x00, 0x07, 0xE0, 0x01, 0xFF,
    0xF8, 0x10, 0x00, 0x00, 0x01, 0x80, 0x01, 0xFF, 0xF8, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x03, 0xFF, 0xF8, 0x20, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF,
    0xFC, 0x20, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0xFC, 0x20, 0x00, 0x00,
    0x00, 0x00, 0x07, 0xFF, 0xFC, 0x40, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF,
    0xFE, 0x40, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFE, 0x40, 0x00, 0x00,
    0x00, 0x00, 0x1F, 0xFF, 0xFE, 0x40, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xFF,
    0xFE, 0x40, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFE, 0x40, 0x00, 0x00,
    0x00, 0x03, 0xFF, 0xFF, 0xFE, 0x40, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xFF,
    0xFE, 0x40, 0x00, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFE, 0x40, 0x00, 0x00,
    0x3F, 0xFF, 0xFF, 0xFF, 0xFE, 0x40, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFE, 0x40, 0x00, 0x03, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x40, 0x00, 0x07,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x40, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFE, 0x40, 0x00, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0x20, 0x00, 0x1F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x20, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFC, 0x20, 0x00, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x00, 0x00, 0x3F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xF8, 0x10, 0x00, 0x7F, 0xFE, 0x7F, 0xFF, 0xFF,
    0xF8, 0x10, 0x00, 0x7F, 0xF8, 0x1F, 0xFF, 0xFF, 0xF8, 0x08, 0x00, 0x7F,
    0xF0, 0x0F, 0xFF, 0xFF, 0xF0, 0x08, 0x00, 0x7F, 0xF0, 0x0F, 0xFF, 0xFF,
    0xF0, 0x04, 0x00, 0x7F, 0xF0, 0x0F, 0xFF, 0xFF, 0xE0, 0x00, 0x00, 0x7F,
    0xF0, 0x0F, 0xFF, 0xFF, 0xC0, 0x02, 0x00, 0x7F, 0xF8, 0x1F, 0xFF, 0xFF,
    0xC0, 0x01, 0x00, 0x7F, 0xFC, 0x3F, 0xFF, 0xFF, 0x80, 0x00, 0x80, 0x7F,
    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x40, 0x3F, 0xFF, 0xFF, 0xFF, 0xFE,
    0x00, 0x00, 0x60, 0x3F, 0xFF, 0xFF, 0xFF, 0xFE, 0x00, 0x00, 0x30, 0x1F,
    0xFF, 0xFF, 0xFF, 0xFC, 0x00, 0x00, 0x08, 0x1F, 0xFF, 0xFF, 0xFF, 0xF8,
    0x00, 0x00, 0x04, 0x0F, 0xFF, 0xFF, 0xFF, 0xE0, 0x00, 0x00, 0x02, 0x07,
    0xFF, 0xFF, 0xFF, 0xC0, 0x00, 0x00, 0x00, 0x83, 0xFF, 0xFF, 0xFF, 0x00,
    0x00, 0x00, 0x00, 0x61, 0xFF, 0xFF, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x1C,
    0x7F, 0xFF, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x03, 0x9F, 0xFF, 0xC0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7F, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
};

void display_init()
{
    display.init(115200);
    display.setRotation(0);
    display.setFullWindow();
    display.firstPage();
    do {
        display.fillScreen(GxEPD_WHITE);
    } while (display.nextPage());
}

void display_redraw()
{
    static int cnt = 0;
    cnt++;

    display.setRotation(0);
    display.setFont(&FreeMonoBold9pt7b);
    display.setTextColor(GxEPD_BLACK);

    thermocouple_meas_t T = thermocouple_get();
    String str = "T_int: "
                 + String(T.temp_internal, 2)
                 + ", T_ext:"
                 + String(T.temp_external, 2)
                 + ", cnt: "
                 + String(cnt);

    display.setPartialWindow(0, 0, display.width(), display.height());
    display.firstPage();
    do {
        display.fillScreen(GxEPD_WHITE);
        display.setCursor(10, 15);
        display.print(str);

        display.drawBitmap(100, 100, MagickImage, 64, 64, GxEPD_BLACK);
    } while (display.nextPage());
}
